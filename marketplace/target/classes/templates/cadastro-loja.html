<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Loja | Na Loja Tem</title>
    <link rel="stylesheet" th:href="@{/estilos/style.css}">
    <link rel="stylesheet" th:href="@{/estilos/cadastro-loja.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header th:replace="~{cabecalho :: header}"></header>

<main>
    <section class="page-header">
        <div class="container">
            <h1><i class="fas fa-store"></i> Cadastrar Minha Loja</h1>
            <p>Junte-se ao maior marketplace do Brasil e alcance milhares de clientes</p>
        </div>
    </section>

    <div class="container">
        <div class="step-indicator">
            <div class="step-line"></div>
            <div class="step active" data-step="1">1</div>
            <div class="step" data-step="2">2</div>
            <div class="step" data-step="3">3</div>
        </div>

        <form id="store-form" class="form-container" th:action="@{/api/lojas-form}" method="post" enctype="multipart/form-data" novalidate>
            <!-- Passo 1: Informa√ß√µes B√°sicas -->
            <div class="form-step active" id="step1">
                <div class="step-header">
                    <h2 class="step-title">Informa√ß√µes B√°sicas</h2>
                    <p class="step-subtitle">Forne√ßa as informa√ß√µes essenciais da sua loja para come√ßar</p>
                </div>

                <div class="form-group">
                    <label for="nome-loja" class="required"><i class="fas fa-sign"></i> Nome da Loja:</label>
                    <input type="text" id="nome-loja" name="nome" required
                           placeholder="Ex: Minha Loja Online" minlength="3" maxlength="100">
                </div>

                <div class="form-group">
                    <label for="cnpj" class="required"><i class="fas fa-id-card"></i> CNPJ:</label>
                    <input type="text" id="cnpj" name="cnpj" required
                           placeholder="00.000.000/0000-00">
                </div>

                <div class="form-group">
                    <label for="descricao" class="required"><i class="fas fa-align-left"></i> Descri√ß√£o da Loja:</label>
                    <textarea id="descricao" name="descricao" required
                              placeholder="Descreva sua loja, seus produtos e seu diferencial..."
                              minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="descricao-chars">0</span>/500</div>
                </div>

                <!-- No arquivo cadastro-loja.html -->
                <div class="form-group">
                    <label for="categoria" class="required"><i class="fas fa-tags"></i> Categoria da Loja:</label>
                    <select id="categoria" name="categoria" required>
                        <option value="">Selecione a categoria principal da sua loja</option>
                        <option value="papelaria">Papelaria</option>
                        <option value="esportes">Esportes</option>
                        <option value="livros">Livros</option>
                        <option value="games">Games</option>
                        <option value="roupas">Roupas</option>
                    </select>
                </div>

                <div class="form-actions">
                    <div></div>
                    <button type="button" class="btn-form btn-next" data-next="2">
                        Pr√≥ximo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Passo 2: Endere√ßo -->
            <div class="form-step" id="step2">
                <div class="step-header">
                    <h2 class="step-title">Endere√ßo da Loja</h2>
                    <p class="step-subtitle">Informe o endere√ßo da sua loja</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cep" class="required"><i class="fas fa-map-pin"></i> CEP:</label>
                        <input type="text" id="cep" name="cep" required
                               placeholder="00000-000">
                        <button type="button" id="btn-buscar-cep" class="btn-small">Buscar</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="logradouro" class="required"><i class="fas fa-road"></i> Logradouro:</label>
                    <input type="text" id="logradouro" name="logradouro" required
                           placeholder="Rua, Avenida, etc.">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="numero" class="required"><i class="fas fa-hashtag"></i> N√∫mero:</label>
                        <input type="text" id="numero" name="numero" required
                               placeholder="N√∫mero">
                    </div>

                    <div class="form-group">
                        <label for="complemento"><i class="fas fa-building"></i> Complemento:</label>
                        <input type="text" id="complemento" name="complemento"
                               placeholder="Apto, Sala, etc.">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bairro" class="required"><i class="fas fa-location-dot"></i> Bairro:</label>
                        <input type="text" id="bairro" name="bairro" required
                               placeholder="Nome do bairro">
                    </div>

                    <div class="form-group">
                        <label for="cidade" class="required"><i class="fas fa-city"></i> Cidade:</label>
                        <input type="text" id="cidade" name="cidade" required
                               placeholder="Nome da cidade">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="estado" class="required"><i class="fas fa-map"></i> Estado:</label>
                        <select id="estado" name="estado" required>
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-form btn-prev" data-prev="1">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn-form btn-next" data-next="3">
                        Pr√≥ximo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Passo 3: Logo da Loja -->
            <div class="form-step" id="step3">
                <div class="step-header">
                    <h2 class="step-title">Logo da Loja</h2>
                    <p class="step-subtitle">Adicione uma imagem para identificar sua loja</p>
                </div>

                <div class="form-group">
                    <label for="logo-loja"><i class="fas fa-image"></i> Logo da Loja (opcional):</label>
                    <div class="file-upload">
                        <input type="file" id="logo-loja" name="foto" accept="image/*">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Clique para fazer upload do logo<br>
                            <small>Formatos: JPG, PNG. Tamanho m√°ximo: 5MB</small></p>
                        <img class="preview-image" alt="Pr√©via do logo">
                    </div>
                </div>

                <div class="form-group">
                    <label for="telefone"><i class="fas fa-phone"></i> Telefone de Contato:</label>
                    <input type="tel" id="telefone" name="telefone"
                           placeholder="(11) 99999-9999">
                </div>

                <div class="form-group">
                    <label for="site"><i class="fas fa-globe"></i> Site (opcional):</label>
                    <input type="url" id="site" name="site"
                           placeholder="https://seusite.com">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-form btn-prev" data-prev="2">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="submit" class="btn-form btn-submit">
                        <i class="fas fa-check"></i> Finalizar Cadastro
                    </button>
                </div>
            </div>
        </form>
    </div>
</main>

<footer th:replace="~{rodape :: footer}"></footer>

<script>
    // ========== CADASTRO LOJA - SCRIPT DIRETO NO HTML ==========
    console.log('üöÄ CADASTRO LOJA - SCRIPT INICIADO');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM Carregado - Iniciando cadastro loja');

        // ========== CONFIGURA√á√ïES ==========
        const formSteps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.step');
        let currentStep = 0;

        console.log(`üìä ${formSteps.length} passos encontrados`);

        if (formSteps.length === 0) {
            console.error('‚ùå Nenhum passo encontrado! Verifique a estrutura HTML.');
            return;
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========
        function showStep(stepIndex) {
            console.log(`üì± Indo para passo ${stepIndex + 1}`);

            // Esconder todos os passos
            formSteps.forEach(step => step.classList.remove('active'));

            // Mostrar passo atual
            if (formSteps[stepIndex]) {
                formSteps[stepIndex].classList.add('active');
            }

            // Atualizar indicadores
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index < stepIndex) {
                    indicator.classList.add('completed');
                } else if (index === stepIndex) {
                    indicator.classList.add('active');
                }
            });

            currentStep = stepIndex;

            // Scroll suave para o topo do formul√°rio
            window.scrollTo({ top: 200, behavior: 'smooth' });
        }

        function validateStep(stepIndex) {
            console.log(`üîç Validando passo ${stepIndex + 1}`);

            const step = formSteps[stepIndex];
            if (!step) return false;

            const requiredInputs = step.querySelectorAll('[required]');
            let isValid = true;

            for (let input of requiredInputs) {
                if (!input.value.trim()) {
                    // Mensagem de erro
                    const label = input.previousElementSibling?.textContent || 'Campo obrigat√≥rio';
                    const message = `‚ùå Por favor, preencha: ${label.replace(':', '').trim()}`;

                    // Usar notifica√ß√£o global se existir, sen√£o alert
                    if (typeof window.showNotification === 'function') {
                        window.showNotification(message, 'error');
                    } else {
                        alert(message);
                    }

                    input.focus();
                    isValid = false;
                    break;
                }
            }

            return isValid;
        }

        // ========== M√ÅSCARAS PARA CAMPOS ==========
        function initMasks() {
            // CNPJ
            const cnpjInput = document.getElementById('cnpj');
            if (cnpjInput) {
                cnpjInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 14) value = value.substring(0, 14);

                    if (value.length > 12) {
                        value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
                    } else if (value.length > 8) {
                        value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
                    } else if (value.length > 5) {
                        value = value.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
                    } else if (value.length > 2) {
                        value = value.replace(/(\d{2})(\d{0,3})/, '$1.$2');
                    }

                    e.target.value = value;
                });
            }

            // CEP
            const cepInput = document.getElementById('cep');
            if (cepInput) {
                cepInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 8) value = value.substring(0, 8);

                    if (value.length > 5) {
                        value = value.replace(/(\d{5})(\d{0,3})/, '$1-$2');
                    }

                    e.target.value = value;

                    // Buscar CEP autom√°tico
                    if (value.length === 8) {
                        buscarCEP(value);
                    }
                });
            }

            // Telefone
            const telInput = document.getElementById('telefone');
            if (telInput) {
                telInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);

                    if (value.length > 10) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    } else if (value.length > 6) {
                        value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                    } else if (value.length > 2) {
                        value = value.replace(/(\d{2})(\d{0,4})/, '($1) $2');
                    }

                    e.target.value = value;
                });
            }
        }

        // ========== BUSCAR CEP ==========
        async function buscarCEP(cep) {
            const cepLimpo = cep.replace(/\D/g, '');
            if (cepLimpo.length !== 8) return;

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
                const data = await response.json();

                if (!data.erro) {
                    document.getElementById('logradouro').value = data.logradouro || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.localidade || '';

                    const estadoSelect = document.getElementById('estado');
                    if (estadoSelect) {
                        for (let option of estadoSelect.options) {
                            if (option.value === data.uf) {
                                estadoSelect.value = data.uf;
                                break;
                            }
                        }
                    }

                    if (typeof window.showNotification === 'function') {
                        window.showNotification('‚úÖ Endere√ßo preenchido automaticamente!', 'success');
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        // ========== UPLOAD DE IMAGEM ==========
        function initImageUpload() {
            const fileInput = document.getElementById('logo-loja');
            const preview = document.querySelector('.preview-image');
            const uploadArea = document.querySelector('.file-upload');

            if (!fileInput || !preview || !uploadArea) return;

            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar
                if (!file.type.match('image.*')) {
                    alert('‚ùå Por favor, selecione uma imagem.');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå A imagem deve ter menos de 5MB.');
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.src = event.target.result;
                    preview.style.display = 'block';

                    // Esconder √≠cone e texto
                    const icon = uploadArea.querySelector('i');
                    const text = uploadArea.querySelector('p');
                    if (icon) icon.style.display = 'none';
                    if (text) text.style.display = 'none';

                    // Adicionar bot√£o de remover
                    addRemoveButton();
                };
                reader.readAsDataURL(file);
            });
        }

        function addRemoveButton() {
            // Remover bot√£o anterior se existir
            const oldBtn = document.querySelector('.remove-img-btn');
            if (oldBtn) oldBtn.remove();

            const uploadArea = document.querySelector('.file-upload');
            if (!uploadArea) return;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-img-btn';
            removeBtn.innerHTML = '‚ùå Remover';
            removeBtn.style.cssText = `
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #d32f2f;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            `;

            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();

                const fileInput = document.getElementById('logo-loja');
                const preview = document.querySelector('.preview-image');
                const uploadArea = document.querySelector('.file-upload');

                if (fileInput) fileInput.value = '';
                if (preview) preview.style.display = 'none';

                // Mostrar √≠cone e texto novamente
                const icon = uploadArea.querySelector('i');
                const text = uploadArea.querySelector('p');
                if (icon) icon.style.display = 'block';
                if (text) text.style.display = 'block';

                this.remove();
            });

            uploadArea.style.position = 'relative';
            uploadArea.appendChild(removeBtn);
        }

        // ========== CONFIGURAR BOT√ïES ==========
        function setupButtons() {
            // Bot√µes "Pr√≥ximo"
            document.querySelectorAll('.btn-next').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();

                    if (validateStep(currentStep)) {
                        const nextStep = parseInt(this.dataset.next) - 1;
                        if (nextStep < formSteps.length) {
                            showStep(nextStep);
                        }
                    }
                });
            });

            // Bot√µes "Anterior"
            document.querySelectorAll('.btn-prev').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const prevStep = parseInt(this.dataset.prev) - 1;
                    if (prevStep >= 0) {
                        showStep(prevStep);
                    }
                });
            });
        }

        // ========== ENVIO DO FORMUL√ÅRIO ==========
        function setupFormSubmit() {
            const form = document.getElementById('store-form');
            if (!form) return;

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üì§ Enviando formul√°rio...');

                // Validar todos os passos
                for (let i = 0; i < formSteps.length; i++) {
                    if (!validateStep(i)) {
                        showStep(i);
                        return;
                    }
                }

                // Remover m√°scaras
                const cnpjInput = document.getElementById('cnpj');
                const cepInput = document.getElementById('cep');
                const telInput = document.getElementById('telefone');

                if (cnpjInput) cnpjInput.value = cnpjInput.value.replace(/\D/g, '');
                if (cepInput) cepInput.value = cepInput.value.replace(/\D/g, '');
                if (telInput) telInput.value = telInput.value.replace(/\D/g, '');

                // Mostrar carregamento
                const submitBtn = form.querySelector('.btn-submit');
                const originalHtml = submitBtn ? submitBtn.innerHTML : '';

                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
                    submitBtn.disabled = true;
                }

                // Enviar dados
                try {
                    const formData = new FormData(form);
                    const token = localStorage.getItem('jwtToken');

                    const response = await fetch('/api/lojas-form', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        if (typeof window.showNotification === 'function') {
                            window.showNotification('‚úÖ Loja cadastrada com sucesso!', 'success');
                        } else {
                            alert('‚úÖ Loja cadastrada com sucesso!');
                        }

                        // Atualizar localStorage
                        const user = JSON.parse(localStorage.getItem('usuario') || '{}');
                        user.temLoja = true;
                        localStorage.setItem('usuario', JSON.stringify(user));

                        // Redirecionar
                        setTimeout(() => {
                            window.location.href = '/minha-loja';
                        }, 1500);

                    } else {
                        throw new Error(result.message || 'Erro ao cadastrar loja');
                    }

                } catch (error) {
                    console.error('‚ùå Erro:', error);

                    if (typeof window.showNotification === 'function') {
                        window.showNotification(`‚ùå ${error.message}`, 'error');
                    } else {
                        alert(`‚ùå ${error.message}`);
                    }

                } finally {
                    if (submitBtn) {
                        submitBtn.innerHTML = originalHtml;
                        submitBtn.disabled = false;
                    }
                }
            });
        }

        // ========== BOT√ÉO BUSCAR CEP ==========
        function setupCepButton() {
            const cepBtn = document.getElementById('btn-buscar-cep');
            if (cepBtn) {
                cepBtn.addEventListener('click', function() {
                    const cepInput = document.getElementById('cep');
                    if (cepInput && cepInput.value) {
                        buscarCEP(cepInput.value);
                    } else {
                        alert('‚ùå Digite um CEP primeiro');
                        cepInput?.focus();
                    }
                });
            }
        }

        // ========== CONTADOR DE CARACTERES ==========
        function setupCharCounter() {
            const descricao = document.getElementById('descricao');
            const counter = document.getElementById('descricao-chars');

            if (descricao && counter) {
                descricao.addEventListener('input', function() {
                    counter.textContent = this.value.length;
                });
            }
        }

        // ========== INICIALIZAR TUDO ==========
        function init() {
            console.log('‚öôÔ∏è Inicializando cadastro loja...');

            initMasks();
            initImageUpload();
            setupButtons();
            setupFormSubmit();
            setupCepButton();
            setupCharCounter();

            // Mostrar primeiro passo
            showStep(0);

            console.log('üéâ Cadastro loja pronto para uso!');
            console.log('üí° Dica: No console use window.currentStep para ver o passo atual');
        }

        // Expor vari√°veis para debug
        window.currentStep = currentStep;
        window.cadastroLoja = {
            showStep: showStep,
            validateStep: validateStep,
            init: init
        };

        // Iniciar
        init();
    });

    console.log('üìÑ Script de cadastro loja carregado (aguardando DOM)');
</script>
</body>
</html>